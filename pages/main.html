<head>
  <title>Forum</title>
  <link rel="stylesheet" type="text/css" href="/pages/style/styles.css">
  <style>
    /* Styling for category buttons */
    .category-buttons button {
      background-color: #333; /* Navy blue background */
      color: white; /* White text color */
      border: none; /* Remove default border */
      border-radius: 5px; /* Rounded corners */
      padding: 10px 20px; /* Padding for button */
      margin: 5px; /* Space between buttons */
      font-size: 16px; /* Font size */
      cursor: pointer; /* Pointer cursor on hover */
      transition: background-color 0.3s; /* Smooth background color transition */
    }

    .category-buttons button:hover {
      background-color: darkblue; /* Darker blue on hover */
    }
  </style>
</head>


<body>
  <header>
    <h1>Forum</h1>
    <nav>
      <a href="/pages/login.html" class="login-btn">Login</a>
      <a href="/pages/add-post.html" class="add-post-btn">➕</a>
    </nav>
  </header>

  <div class="container">
    <div id="categoryButtons" class="category-buttons">
      <!-- Categories will be dynamically populated here -->
    </div>
    <div id="posts">
      <!-- Posts will be dynamically generated here -->
    </div>
  </div>
</body>

<script>
  let allPosts = []; // Store all posts here

  async function loadCategories() {
    try {
      const response = await fetch('/categories');
      if (response.ok) {
        const categories = await response.json();
        const categoryButtons = document.getElementById('categoryButtons');

        categories.forEach(category => {
          const button = document.createElement('button');
          button.textContent = category.name;
          button.dataset.categoryId = category.category_id; // Ensure this matches the IDs in your data
          button.onclick = handleCategoryClick;
          categoryButtons.appendChild(button);
        });
      } else {
        console.error('Failed to load categories');
        alert('Failed to load categories. Please refresh the page.');
      }
    } catch (error) {
      console.error('Error loading categories:', error);
      alert('Failed to load categories. Please try again later.');
    }
  }

  async function loadAllPosts() {
    try {
      const response = await fetch('/get-posts');
      if (response.ok) {
        allPosts = await response.json();
        displayPosts(allPosts);
      } else {
        console.error('Failed to load posts');
        alert('Failed to load posts. Please refresh the page.');
      }
    } catch (error) {
      console.error('Error loading posts:', error);
      alert('Failed to load posts. Please try again later.');
    }
  }

  function displayPosts(posts) {
    const postsContainer = document.getElementById("posts");
    postsContainer.innerHTML = ''; // Clear existing posts

    posts.forEach(postData => {
      const postLink = document.createElement("a");
      const post = document.createElement("div");
      const postHeader = document.createElement("div");
      const postContent = document.createElement("p");
      const postActions = document.createElement("div");
      const postCategory = document.createElement("span");
      const like = document.createElement("span");
      const comment = document.createElement("span");

      postLink.href = `/pages/post.html?id=${postData.post_id}`;
      postLink.classList.add("post-link");

      postContent.textContent = `${postData.message}`;

      postData.categories.forEach(cat => {
        postCategory.textContent += `${cat.name} `;
      });

      like.textContent = `❤️ ${postData.like_count}`;
      comment.textContent = `💬 Comments`;

      post.classList.add("post");
      postHeader.classList.add("post-header");
      postActions.classList.add("post-actions");
      postCategory.classList.add("category");
      like.classList.add("like");
      comment.classList.add("comment");

      postHeader.appendChild(postCategory);
      postHeader.append(` ${postData.title}`);

      postActions.appendChild(like);
      postActions.appendChild(comment);

      post.appendChild(postHeader);
      post.appendChild(postContent);
      post.appendChild(postActions);

      postLink.appendChild(post);
      postsContainer.appendChild(postLink);
    });
  }

  function handleCategoryClick(event) {
    const categoryId = parseInt(event.target.dataset.categoryId, 10); // Ensure it's an integer
    console.log(`Category clicked: ${categoryId}`);

    if (categoryId === 'all') {
      displayPosts(allPosts);
    } else {
      const filteredPosts = allPosts.filter(post =>
        post.categories.some(cat => cat.category_id === categoryId)
      );
      console.log('Filtered posts:', filteredPosts); // Debugging line
      displayPosts(filteredPosts);
    }
  }

  window.onload = function() {
    loadCategories();
    loadAllPosts(); // Load all posts initially
  };
</script>
